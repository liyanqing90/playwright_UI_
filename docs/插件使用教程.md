# æ’ä»¶ä½¿ç”¨æ•™ç¨‹

## å¿«é€Ÿå¼€å§‹

æœ¬æ•™ç¨‹å°†æŒ‡å¯¼æ‚¨å¦‚ä½•åœ¨è‡ªåŠ¨åŒ–æµ‹è¯•æ¡†æ¶ä¸­ä½¿ç”¨æ’ä»¶ç³»ç»Ÿï¼ŒåŒ…æ‹¬åŠ è½½ç°æœ‰æ’ä»¶ã€åˆ›å»ºè‡ªå®šä¹‰æ’ä»¶ä»¥åŠç®¡ç†æ’ä»¶é…ç½®ã€‚

## ç¬¬ä¸€æ­¥ï¼šäº†è§£æ’ä»¶ç³»ç»Ÿ

### ä»€ä¹ˆæ˜¯æ’ä»¶ï¼Ÿ

æ’ä»¶æ˜¯æ‰©å±•è‡ªåŠ¨åŒ–æ¡†æ¶åŠŸèƒ½çš„ç‹¬ç«‹æ¨¡å—ï¼Œå¯ä»¥æ·»åŠ æ–°çš„å‘½ä»¤ç±»å‹è€Œæ— éœ€ä¿®æ”¹æ ¸å¿ƒä»£ç ã€‚æ¯ä¸ªæ’ä»¶å¯ä»¥åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªè‡ªå®šä¹‰å‘½ä»¤ã€‚

### æ’ä»¶çš„ä¼˜åŠ¿

- **æ¨¡å—åŒ–**ï¼šåŠŸèƒ½ç‹¬ç«‹ï¼Œæ˜“äºç»´æŠ¤
- **å¯æ‰©å±•**ï¼šæ— éœ€ä¿®æ”¹æ ¸å¿ƒä»£ç å³å¯æ·»åŠ æ–°åŠŸèƒ½
- **å¯é‡ç”¨**ï¼šæ’ä»¶å¯ä»¥åœ¨ä¸åŒé¡¹ç›®é—´å…±äº«
- **çƒ­æ’æ‹”**ï¼šæ”¯æŒè¿è¡Œæ—¶åŠ è½½å’Œå¸è½½

## ç¬¬äºŒæ­¥ï¼šä½¿ç”¨ç°æœ‰æ’ä»¶

### 2.1 æŸ¥çœ‹å¯ç”¨æ’ä»¶

```python
from src.automation.commands.plugin_manager import PluginManager

# åˆ›å»ºæ’ä»¶ç®¡ç†å™¨
plugin_manager = PluginManager()

# å‘ç°æ’ä»¶ç›®å½•ä¸­çš„æ‰€æœ‰æ’ä»¶
plugins = plugin_manager.discover_plugins('plugins')
print("å¯ç”¨æ’ä»¶:")
for plugin in plugins:
    print(f"- {plugin['name']} v{plugin['version']}: {plugin['description']}")
```

### 2.2 åŠ è½½æ’ä»¶

```python
# åŠ è½½å•ä¸ªæ’ä»¶
success = plugin_manager.load_plugin('plugins/custom_command_plugin.py')
if success:
    print("æ’ä»¶åŠ è½½æˆåŠŸ")
else:
    print("æ’ä»¶åŠ è½½å¤±è´¥")

# æ‰¹é‡åŠ è½½æ‰€æœ‰æ’ä»¶
def load_all_plugins():
    plugins = plugin_manager.discover_plugins('plugins')
    loaded_count = 0
    
    for plugin in plugins:
        try:
            if plugin_manager.load_plugin(plugin['path']):
                print(f"âœ“ å·²åŠ è½½: {plugin['name']}")
                loaded_count += 1
            else:
                print(f"âœ— åŠ è½½å¤±è´¥: {plugin['name']}")
        except Exception as e:
            print(f"âœ— åŠ è½½é”™è¯¯: {plugin['name']} - {e}")
    
    print(f"\næˆåŠŸåŠ è½½ {loaded_count}/{len(plugins)} ä¸ªæ’ä»¶")
    return loaded_count

load_all_plugins()
```

### 2.3 æŸ¥çœ‹å·²åŠ è½½çš„æ’ä»¶

```python
# åˆ—å‡ºæ‰€æœ‰å·²åŠ è½½çš„æ’ä»¶
loaded_plugins = plugin_manager.list_plugins()
print("å·²åŠ è½½çš„æ’ä»¶:")
for name, info in loaded_plugins.items():
    print(f"- {name}: {info['description']}")
    print(f"  ç‰ˆæœ¬: {info['version']}")
    print(f"  å‘½ä»¤: {', '.join(info['commands'])}")
    print()
```

### 2.4 ä½¿ç”¨æ’ä»¶å‘½ä»¤

```python
from src.automation.commands.command_executor import CommandExecutor
from src.automation.commands.base_command import CommandRegistry

# ç¡®ä¿å‘½ä»¤å·²æ³¨å†Œ
CommandRegistry.auto_discover_commands('src.automation.commands')

# åˆ›å»ºæ‰§è¡Œå™¨
executor = CommandExecutor()

# ä½¿ç”¨æ’ä»¶æä¾›çš„è‡ªå®šä¹‰ç­‰å¾…å‘½ä»¤
step = {
    'action': 'custom_wait',
    'wait_time': 3.0,
    'reason': 'ç­‰å¾…é¡µé¢å®Œå…¨åŠ è½½'
}

result = executor.execute_command(
    command_name='custom_wait',
    ui_helper=None,  # å®é™…ä½¿ç”¨æ—¶ä¼ å…¥UIåŠ©æ‰‹
    selector='',
    value=step['wait_time'],
    step=step
)
print(f"ç­‰å¾…å‘½ä»¤æ‰§è¡Œç»“æœ: {result}")

# ä½¿ç”¨è‡ªå®šä¹‰æ—¥å¿—å‘½ä»¤
log_step = {
    'action': 'custom_log',
    'message': 'è¿™æ˜¯ä¸€æ¡è‡ªå®šä¹‰æ—¥å¿—',
    'level': 'info',
    'category': 'test'
}

log_result = executor.execute_command(
    command_name='custom_log',
    ui_helper=None,
    selector='',
    value=log_step['message'],
    step=log_step
)
print(f"æ—¥å¿—å‘½ä»¤æ‰§è¡Œç»“æœ: {log_result}")
```

## ç¬¬ä¸‰æ­¥ï¼šåˆ›å»ºè‡ªå®šä¹‰æ’ä»¶

### 3.1 åˆ›å»ºæ’ä»¶æ–‡ä»¶

åˆ›å»ºæ–‡ä»¶ `plugins/my_custom_plugin.py`ï¼š

```python
"""æˆ‘çš„è‡ªå®šä¹‰æ’ä»¶"""

from typing import Dict, Any
import logging
import time
import requests

from src.automation.commands.base_command import Command, CommandRegistry

logger = logging.getLogger(__name__)

# æ’ä»¶å…ƒæ•°æ®
PLUGIN_INFO = {
    'name': 'MyCustomPlugin',
    'version': '1.0.0',
    'description': 'æˆ‘çš„ç¬¬ä¸€ä¸ªè‡ªå®šä¹‰æ’ä»¶',
    'author': 'æ‚¨çš„å§“å',
    'commands': ['http_request', 'data_generator', 'file_operation']
}


@CommandRegistry.register('http_request')
class HttpRequestCommand(Command):
    """HTTPè¯·æ±‚å‘½ä»¤"""
    
    def validate_args(self, ui_helper, selector: str, value: Any, step: Dict[str, Any]) -> bool:
        url = step.get('url', value)
        if not url:
            logger.error("URL is required for HTTP request")
            return False
        
        method = step.get('method', 'GET').upper()
        if method not in ['GET', 'POST', 'PUT', 'DELETE', 'PATCH']:
            logger.error(f"Unsupported HTTP method: {method}")
            return False
        
        return True
    
    def execute(self, ui_helper, selector: str, value: Any, step: Dict[str, Any]) -> Dict[str, Any]:
        self.before_execute(ui_helper, selector, value, step)
        
        try:
            url = step.get('url', value)
            method = step.get('method', 'GET').upper()
            headers = step.get('headers', {})
            data = step.get('data')
            timeout = step.get('timeout', 30)
            
            logger.info(f"å‘é€ {method} è¯·æ±‚åˆ°: {url}")
            
            response = requests.request(
                method=method,
                url=url,
                headers=headers,
                json=data if data else None,
                timeout=timeout
            )
            
            result = {
                'status_code': response.status_code,
                'headers': dict(response.headers),
                'content': response.text,
                'json': response.json() if response.headers.get('content-type', '').startswith('application/json') else None,
                'success': 200 <= response.status_code < 300
            }
            
            logger.info(f"HTTPè¯·æ±‚å®Œæˆï¼ŒçŠ¶æ€ç : {response.status_code}")
            
            self.after_execute(result, ui_helper, selector, value, step)
            return result
            
        except Exception as e:
            self.on_error(e, ui_helper, selector, value, step)
            raise


@CommandRegistry.register('data_generator')
class DataGeneratorCommand(Command):
    """æ•°æ®ç”Ÿæˆå‘½ä»¤"""
    
    def validate_args(self, ui_helper, selector: str, value: Any, step: Dict[str, Any]) -> bool:
        data_type = step.get('type', 'string')
        if data_type not in ['string', 'number', 'email', 'phone', 'name', 'address']:
            logger.error(f"Unsupported data type: {data_type}")
            return False
        return True
    
    def execute(self, ui_helper, selector: str, value: Any, step: Dict[str, Any]) -> str:
        self.before_execute(ui_helper, selector, value, step)
        
        try:
            data_type = step.get('type', 'string')
            length = step.get('length', 10)
            
            if data_type == 'string':
                import string
                import random
                result = ''.join(random.choices(string.ascii_letters + string.digits, k=length))
            
            elif data_type == 'number':
                import random
                min_val = step.get('min', 1)
                max_val = step.get('max', 1000)
                result = str(random.randint(min_val, max_val))
            
            elif data_type == 'email':
                import random
                import string
                username = ''.join(random.choices(string.ascii_lowercase, k=8))
                domain = random.choice(['gmail.com', 'yahoo.com', 'hotmail.com', 'example.com'])
                result = f"{username}@{domain}"
            
            elif data_type == 'phone':
                import random
                result = f"1{''.join([str(random.randint(0, 9)) for _ in range(10)])}"
            
            elif data_type == 'name':
                import random
                first_names = ['å¼ ', 'æ', 'ç‹', 'åˆ˜', 'é™ˆ', 'æ¨', 'èµµ', 'é»„', 'å‘¨', 'å´']
                last_names = ['ä¼Ÿ', 'èŠ³', 'å¨œ', 'æ•', 'é™', 'ä¸½', 'å¼º', 'ç£Š', 'å†›', 'æ´‹']
                result = random.choice(first_names) + random.choice(last_names)
            
            elif data_type == 'address':
                import random
                cities = ['åŒ—äº¬å¸‚', 'ä¸Šæµ·å¸‚', 'å¹¿å·å¸‚', 'æ·±åœ³å¸‚', 'æ­å·å¸‚', 'å—äº¬å¸‚']
                districts = ['æœé˜³åŒº', 'æµ·æ·€åŒº', 'è¥¿åŸåŒº', 'ä¸œåŸåŒº', 'ä¸°å°åŒº', 'çŸ³æ™¯å±±åŒº']
                streets = ['ä¸­å±±è·¯', 'äººæ°‘è·¯', 'å»ºè®¾è·¯', 'è§£æ”¾è·¯', 'å’Œå¹³è·¯', 'èƒœåˆ©è·¯']
                result = f"{random.choice(cities)}{random.choice(districts)}{random.choice(streets)}{random.randint(1, 999)}å·"
            
            else:
                result = "unknown"
            
            logger.info(f"ç”Ÿæˆ {data_type} ç±»å‹æ•°æ®: {result}")
            
            # å¯é€‰ï¼šå°†ç»“æœå­˜å‚¨åˆ°å˜é‡ä¸­
            var_name = step.get('store_in')
            if var_name and hasattr(ui_helper, 'set_variable'):
                ui_helper.set_variable(var_name, result)
                logger.info(f"æ•°æ®å·²å­˜å‚¨åˆ°å˜é‡: {var_name} = {result}")
            
            self.after_execute(result, ui_helper, selector, value, step)
            return result
            
        except Exception as e:
            self.on_error(e, ui_helper, selector, value, step)
            raise


@CommandRegistry.register('file_operation')
class FileOperationCommand(Command):
    """æ–‡ä»¶æ“ä½œå‘½ä»¤"""
    
    def validate_args(self, ui_helper, selector: str, value: Any, step: Dict[str, Any]) -> bool:
        operation = step.get('operation', 'read')
        if operation not in ['read', 'write', 'append', 'delete', 'exists']:
            logger.error(f"Unsupported file operation: {operation}")
            return False
        
        file_path = step.get('file_path', value)
        if not file_path:
            logger.error("File path is required")
            return False
        
        return True
    
    def execute(self, ui_helper, selector: str, value: Any, step: Dict[str, Any]) -> Any:
        self.before_execute(ui_helper, selector, value, step)
        
        try:
            import os
            
            operation = step.get('operation', 'read')
            file_path = step.get('file_path', value)
            content = step.get('content', '')
            encoding = step.get('encoding', 'utf-8')
            
            logger.info(f"æ‰§è¡Œæ–‡ä»¶æ“ä½œ: {operation} on {file_path}")
            
            if operation == 'read':
                with open(file_path, 'r', encoding=encoding) as f:
                    result = f.read()
                logger.info(f"è¯»å–æ–‡ä»¶æˆåŠŸï¼Œå†…å®¹é•¿åº¦: {len(result)}")
            
            elif operation == 'write':
                with open(file_path, 'w', encoding=encoding) as f:
                    f.write(content)
                result = f"æ–‡ä»¶å†™å…¥æˆåŠŸ: {file_path}"
                logger.info(result)
            
            elif operation == 'append':
                with open(file_path, 'a', encoding=encoding) as f:
                    f.write(content)
                result = f"æ–‡ä»¶è¿½åŠ æˆåŠŸ: {file_path}"
                logger.info(result)
            
            elif operation == 'delete':
                if os.path.exists(file_path):
                    os.remove(file_path)
                    result = f"æ–‡ä»¶åˆ é™¤æˆåŠŸ: {file_path}"
                else:
                    result = f"æ–‡ä»¶ä¸å­˜åœ¨: {file_path}"
                logger.info(result)
            
            elif operation == 'exists':
                result = os.path.exists(file_path)
                logger.info(f"æ–‡ä»¶å­˜åœ¨æ£€æŸ¥: {file_path} = {result}")
            
            else:
                raise ValueError(f"Unknown operation: {operation}")
            
            self.after_execute(result, ui_helper, selector, value, step)
            return result
            
        except Exception as e:
            self.on_error(e, ui_helper, selector, value, step)
            raise


# æ’ä»¶ç”Ÿå‘½å‘¨æœŸå‡½æ•°
def initialize_plugin():
    """åˆå§‹åŒ–æ’ä»¶"""
    logger.info(f"æ­£åœ¨åˆå§‹åŒ–æ’ä»¶: {PLUGIN_INFO['name']} v{PLUGIN_INFO['version']}")
    
    # è®¾ç½®é»˜è®¤é…ç½®
    from src.automation.commands.command_config import command_config_manager
    
    for command_name in PLUGIN_INFO['commands']:
        default_config = {
            'timeout': 30,
            'retry_count': 2,
            'enabled': True,
            'log_level': 'INFO'
        }
        command_config_manager.set_command_config(command_name, default_config)
    
    logger.info(f"æ’ä»¶ {PLUGIN_INFO['name']} åˆå§‹åŒ–å®Œæˆ")
    return PLUGIN_INFO


def cleanup_plugin():
    """æ¸…ç†æ’ä»¶"""
    logger.info(f"æ­£åœ¨æ¸…ç†æ’ä»¶: {PLUGIN_INFO['name']}")
    
    # æ³¨é”€å‘½ä»¤
    from src.automation.commands.base_command import CommandRegistry
    
    for command_name in PLUGIN_INFO['commands']:
        try:
            CommandRegistry.unregister_command(command_name)
            logger.info(f"å·²æ³¨é”€å‘½ä»¤: {command_name}")
        except Exception as e:
            logger.error(f"æ³¨é”€å‘½ä»¤å¤±è´¥ {command_name}: {e}")
    
    logger.info(f"æ’ä»¶ {PLUGIN_INFO['name']} æ¸…ç†å®Œæˆ")


def validate_plugin_config(config: Dict[str, Any]) -> bool:
    """éªŒè¯æ’ä»¶é…ç½®"""
    required_keys = ['enabled']
    
    for key in required_keys:
        if key not in config:
            logger.error(f"ç¼ºå°‘å¿…éœ€çš„é…ç½®é¡¹: {key}")
            return False
    
    return True


def get_plugin_info() -> Dict[str, Any]:
    """è·å–æ’ä»¶ä¿¡æ¯"""
    return PLUGIN_INFO.copy()


if __name__ == '__main__':
    # æµ‹è¯•æ’ä»¶
    print(f"æ’ä»¶: {PLUGIN_INFO['name']}")
    print(f"ç‰ˆæœ¬: {PLUGIN_INFO['version']}")
    print(f"å‘½ä»¤: {', '.join(PLUGIN_INFO['commands'])}")
```

### 3.2 æµ‹è¯•è‡ªå®šä¹‰æ’ä»¶

åˆ›å»ºæµ‹è¯•æ–‡ä»¶ `test_my_plugin.py`ï¼š

```python
"""æµ‹è¯•è‡ªå®šä¹‰æ’ä»¶"""

from src.automation.commands.plugin_manager import PluginManager
from src.automation.commands.command_executor import CommandExecutor
from src.automation.commands.base_command import CommandRegistry

def test_plugin():
    # åŠ è½½æ’ä»¶
    plugin_manager = PluginManager()
    success = plugin_manager.load_plugin('plugins/my_custom_plugin.py')
    
    if not success:
        print("æ’ä»¶åŠ è½½å¤±è´¥")
        return
    
    print("æ’ä»¶åŠ è½½æˆåŠŸ")
    
    # ç¡®ä¿å‘½ä»¤å·²æ³¨å†Œ
    CommandRegistry.auto_discover_commands('src.automation.commands')
    
    # åˆ›å»ºæ‰§è¡Œå™¨
    executor = CommandExecutor()
    
    # æµ‹è¯•HTTPè¯·æ±‚å‘½ä»¤
    print("\næµ‹è¯•HTTPè¯·æ±‚å‘½ä»¤:")
    http_step = {
        'action': 'http_request',
        'url': 'https://httpbin.org/get',
        'method': 'GET',
        'timeout': 10
    }
    
    try:
        result = executor.execute_command(
            command_name='http_request',
            ui_helper=None,
            selector='',
            value=http_step['url'],
            step=http_step
        )
        print(f"HTTPè¯·æ±‚ç»“æœ: çŠ¶æ€ç  {result['status_code']}")
    except Exception as e:
        print(f"HTTPè¯·æ±‚å¤±è´¥: {e}")
    
    # æµ‹è¯•æ•°æ®ç”Ÿæˆå‘½ä»¤
    print("\næµ‹è¯•æ•°æ®ç”Ÿæˆå‘½ä»¤:")
    data_steps = [
        {'action': 'data_generator', 'type': 'email'},
        {'action': 'data_generator', 'type': 'phone'},
        {'action': 'data_generator', 'type': 'name'},
        {'action': 'data_generator', 'type': 'number', 'min': 100, 'max': 999}
    ]
    
    for step in data_steps:
        try:
            result = executor.execute_command(
                command_name='data_generator',
                ui_helper=None,
                selector='',
                value='',
                step=step
            )
            print(f"ç”Ÿæˆ {step['type']}: {result}")
        except Exception as e:
            print(f"æ•°æ®ç”Ÿæˆå¤±è´¥ {step['type']}: {e}")
    
    # æµ‹è¯•æ–‡ä»¶æ“ä½œå‘½ä»¤
    print("\næµ‹è¯•æ–‡ä»¶æ“ä½œå‘½ä»¤:")
    test_file = 'test_output.txt'
    
    # å†™å…¥æ–‡ä»¶
    write_step = {
        'action': 'file_operation',
        'operation': 'write',
        'file_path': test_file,
        'content': 'è¿™æ˜¯æµ‹è¯•å†…å®¹\n'
    }
    
    try:
        result = executor.execute_command(
            command_name='file_operation',
            ui_helper=None,
            selector='',
            value=test_file,
            step=write_step
        )
        print(f"æ–‡ä»¶å†™å…¥: {result}")
    except Exception as e:
        print(f"æ–‡ä»¶å†™å…¥å¤±è´¥: {e}")
    
    # è¯»å–æ–‡ä»¶
    read_step = {
        'action': 'file_operation',
        'operation': 'read',
        'file_path': test_file
    }
    
    try:
        result = executor.execute_command(
            command_name='file_operation',
            ui_helper=None,
            selector='',
            value=test_file,
            step=read_step
        )
        print(f"æ–‡ä»¶å†…å®¹: {result.strip()}")
    except Exception as e:
        print(f"æ–‡ä»¶è¯»å–å¤±è´¥: {e}")
    
    print("\næ’ä»¶æµ‹è¯•å®Œæˆ")

if __name__ == '__main__':
    test_plugin()
```

## ç¬¬å››æ­¥ï¼šæ’ä»¶é…ç½®ç®¡ç†

### 4.1 è®¾ç½®æ’ä»¶é…ç½®

```python
from src.automation.commands.command_config import command_config_manager

# ä¸ºæ’ä»¶å‘½ä»¤è®¾ç½®ç‰¹å®šé…ç½®
command_config_manager.set_command_config('http_request', {
    'timeout': 60,  # HTTPè¯·æ±‚è¶…æ—¶æ—¶é—´
    'retry_count': 3,  # é‡è¯•æ¬¡æ•°
    'enabled': True,
    'log_level': 'INFO',
    'custom_headers': {  # è‡ªå®šä¹‰é…ç½®
        'User-Agent': 'AutomationFramework/1.0'
    }
})

command_config_manager.set_command_config('data_generator', {
    'timeout': 10,
    'enabled': True,
    'default_length': 12,  # é»˜è®¤ç”Ÿæˆé•¿åº¦
    'allowed_types': ['string', 'email', 'phone', 'name']  # å…è®¸çš„æ•°æ®ç±»å‹
})

# ä¿å­˜é…ç½®
command_config_manager.save_config()
print("æ’ä»¶é…ç½®å·²ä¿å­˜")
```

### 4.2 æŸ¥çœ‹æ’ä»¶é…ç½®

```python
# æŸ¥çœ‹ç‰¹å®šå‘½ä»¤çš„é…ç½®
http_config = command_config_manager.get_command_config('http_request')
print(f"HTTPè¯·æ±‚å‘½ä»¤é…ç½®: {http_config}")

# æŸ¥çœ‹æ‰€æœ‰é…ç½®
all_configs = command_config_manager.get_all_configs()
print("æ‰€æœ‰å‘½ä»¤é…ç½®:")
for cmd, config in all_configs.items():
    if cmd.startswith(('http_', 'data_', 'file_')):
        print(f"  {cmd}: {config}")
```

### 4.3 å¯¼å‡ºå’Œå¯¼å…¥é…ç½®

```python
# å¯¼å‡ºé…ç½®åˆ°æ–‡ä»¶
command_config_manager.export_config('my_plugin_config.json')
print("é…ç½®å·²å¯¼å‡ºåˆ° my_plugin_config.json")

# ä»æ–‡ä»¶å¯¼å…¥é…ç½®
command_config_manager.import_config('my_plugin_config.json')
print("é…ç½®å·²ä» my_plugin_config.json å¯¼å…¥")
```

## ç¬¬äº”æ­¥ï¼šæ’ä»¶ç›‘æ§

### 5.1 å¯ç”¨æ’ä»¶ç›‘æ§

```python
from src.automation.commands.command_monitor import command_monitor

# å¯ç”¨ç›‘æ§
command_monitor.enable()

# ä¸ºæ’ä»¶å‘½ä»¤è®¾ç½®ç›‘æ§é˜ˆå€¼
command_monitor.set_threshold('http_request', 'execution_time', 10.0)  # 10ç§’
command_monitor.set_threshold('http_request', 'error_rate', 0.1)       # 10%
command_monitor.set_threshold('data_generator', 'execution_time', 1.0)  # 1ç§’
command_monitor.set_threshold('file_operation', 'execution_time', 5.0)  # 5ç§’

print("æ’ä»¶ç›‘æ§å·²å¯ç”¨")
```

### 5.2 æ·»åŠ ç›‘æ§ç›‘å¬å™¨

```python
# æ·»åŠ æ’ä»¶ç‰¹å®šçš„ç›‘æ§ç›‘å¬å™¨
def on_plugin_performance_issue(command_name: str, metric: str, value: float, threshold: float):
    plugin_commands = ['http_request', 'data_generator', 'file_operation']
    if command_name in plugin_commands:
        print(f"âš ï¸ æ’ä»¶æ€§èƒ½è­¦å‘Š: {command_name}")
        print(f"   æŒ‡æ ‡: {metric}")
        print(f"   å½“å‰å€¼: {value:.2f}")
        print(f"   é˜ˆå€¼: {threshold:.2f}")
        
        # å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å‘Šè­¦é€»è¾‘ï¼Œå¦‚å‘é€é‚®ä»¶ã€é’‰é’‰é€šçŸ¥ç­‰

command_monitor.add_listener('threshold_exceeded', on_plugin_performance_issue)

def on_plugin_command_completed(command_name: str, execution_time: float, success: bool):
    plugin_commands = ['http_request', 'data_generator', 'file_operation']
    if command_name in plugin_commands:
        status = "æˆåŠŸ" if success else "å¤±è´¥"
        print(f"ğŸ“Š æ’ä»¶å‘½ä»¤æ‰§è¡Œ: {command_name} - {status} ({execution_time:.2f}s)")

command_monitor.add_listener('command_completed', on_plugin_command_completed)
```

### 5.3 æŸ¥çœ‹ç›‘æ§æŠ¥å‘Š

```python
# ç”Ÿæˆç›‘æ§æŠ¥å‘Š
report = command_monitor.generate_report()

# è¿‡æ»¤æ’ä»¶å‘½ä»¤çš„ç›‘æ§æ•°æ®
plugin_commands = ['http_request', 'data_generator', 'file_operation']
plugin_report = {cmd: metrics for cmd, metrics in report.items() if cmd in plugin_commands}

print("æ’ä»¶å‘½ä»¤ç›‘æ§æŠ¥å‘Š:")
for command_name, metrics in plugin_report.items():
    print(f"\n{command_name}:")
    print(f"  æ‰§è¡Œæ¬¡æ•°: {metrics.get('execution_count', 0)}")
    print(f"  å¹³å‡æ‰§è¡Œæ—¶é—´: {metrics.get('avg_execution_time', 0):.2f}s")
    print(f"  æœ€å¤§æ‰§è¡Œæ—¶é—´: {metrics.get('max_execution_time', 0):.2f}s")
    print(f"  é”™è¯¯ç‡: {metrics.get('error_rate', 0):.2%}")
    print(f"  æˆåŠŸç‡: {metrics.get('success_rate', 0):.2%}")
```

## ç¬¬å…­æ­¥ï¼šåœ¨æµ‹è¯•ç”¨ä¾‹ä¸­ä½¿ç”¨æ’ä»¶

### 6.1 YAMLæµ‹è¯•ç”¨ä¾‹ç¤ºä¾‹

åˆ›å»ºæµ‹è¯•ç”¨ä¾‹æ–‡ä»¶ `test_data/demo/cases/plugin_test.yaml`ï¼š

```yaml
name: "æ’ä»¶åŠŸèƒ½æµ‹è¯•"
description: "æµ‹è¯•è‡ªå®šä¹‰æ’ä»¶çš„å„ç§å‘½ä»¤"
steps:
  # ç”Ÿæˆæµ‹è¯•æ•°æ®
  - action: data_generator
    type: email
    store_in: test_email
    description: "ç”Ÿæˆæµ‹è¯•é‚®ç®±"
  
  - action: data_generator
    type: phone
    store_in: test_phone
    description: "ç”Ÿæˆæµ‹è¯•ç”µè¯"
  
  - action: data_generator
    type: name
    store_in: test_name
    description: "ç”Ÿæˆæµ‹è¯•å§“å"
  
  # è®°å½•ç”Ÿæˆçš„æ•°æ®
  - action: custom_log
    message: "ç”Ÿæˆçš„æµ‹è¯•æ•°æ® - é‚®ç®±: ${test_email}, ç”µè¯: ${test_phone}, å§“å: ${test_name}"
    level: info
    category: test_data
    description: "è®°å½•ç”Ÿæˆçš„æµ‹è¯•æ•°æ®"
  
  # å°†æ•°æ®å†™å…¥æ–‡ä»¶
  - action: file_operation
    operation: write
    file_path: "test_output/generated_data.txt"
    content: "é‚®ç®±: ${test_email}\nç”µè¯: ${test_phone}\nå§“å: ${test_name}\n"
    description: "ä¿å­˜æµ‹è¯•æ•°æ®åˆ°æ–‡ä»¶"
  
  # å‘é€HTTPè¯·æ±‚éªŒè¯é‚®ç®±æ ¼å¼
  - action: http_request
    url: "https://httpbin.org/post"
    method: POST
    headers:
      Content-Type: "application/json"
    data:
      email: "${test_email}"
      phone: "${test_phone}"
      name: "${test_name}"
    timeout: 30
    description: "å‘é€HTTPè¯·æ±‚éªŒè¯æ•°æ®"
  
  # ç­‰å¾…ä¸€æ®µæ—¶é—´
  - action: custom_wait
    wait_time: 2
    reason: "ç­‰å¾…å¤„ç†å®Œæˆ"
    description: "ç­‰å¾…å¤„ç†"
  
  # è¯»å–å¹¶éªŒè¯æ–‡ä»¶å†…å®¹
  - action: file_operation
    operation: read
    file_path: "test_output/generated_data.txt"
    store_in: file_content
    description: "è¯»å–ä¿å­˜çš„æ•°æ®æ–‡ä»¶"
  
  # è®°å½•æ–‡ä»¶å†…å®¹
  - action: custom_log
    message: "æ–‡ä»¶å†…å®¹: ${file_content}"
    level: info
    category: file_check
    description: "è®°å½•æ–‡ä»¶å†…å®¹"
  
  # æ¸…ç†æµ‹è¯•æ–‡ä»¶
  - action: file_operation
    operation: delete
    file_path: "test_output/generated_data.txt"
    description: "æ¸…ç†æµ‹è¯•æ–‡ä»¶"
```

### 6.2 Pythonæµ‹è¯•è„šæœ¬ç¤ºä¾‹

åˆ›å»ºæµ‹è¯•è„šæœ¬ `test_plugin_integration.py`ï¼š

```python
"""æ’ä»¶é›†æˆæµ‹è¯•"""

import os
import sys
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from src.automation.commands.plugin_manager import PluginManager
from src.automation.commands.command_executor import CommandExecutor
from src.automation.commands.base_command import CommandRegistry
from src.automation.commands.command_monitor import command_monitor
from src.automation.commands.command_config import command_config_manager

def setup_plugins():
    """è®¾ç½®æ’ä»¶ç¯å¢ƒ"""
    print("è®¾ç½®æ’ä»¶ç¯å¢ƒ...")
    
    # åŠ è½½æ’ä»¶
    plugin_manager = PluginManager()
    plugins = plugin_manager.discover_plugins('plugins')
    
    for plugin in plugins:
        success = plugin_manager.load_plugin(plugin['path'])
        print(f"æ’ä»¶ {plugin['name']}: {'åŠ è½½æˆåŠŸ' if success else 'åŠ è½½å¤±è´¥'}")
    
    # æ³¨å†Œå‘½ä»¤
    CommandRegistry.auto_discover_commands('src.automation.commands')
    
    # å¯ç”¨ç›‘æ§
    command_monitor.enable()
    
    # è®¾ç½®é…ç½®
    command_config_manager.set_global_config({
        'default_timeout': 30,
        'enable_monitoring': True,
        'log_level': 'INFO'
    })
    
    print("æ’ä»¶ç¯å¢ƒè®¾ç½®å®Œæˆ")

def run_plugin_test_suite():
    """è¿è¡Œæ’ä»¶æµ‹è¯•å¥—ä»¶"""
    print("\nå¼€å§‹æ’ä»¶æµ‹è¯•å¥—ä»¶...")
    
    executor = CommandExecutor()
    test_results = []
    
    # æµ‹è¯•ç”¨ä¾‹1ï¼šæ•°æ®ç”Ÿæˆå’Œæ–‡ä»¶æ“ä½œ
    print("\næµ‹è¯•ç”¨ä¾‹1ï¼šæ•°æ®ç”Ÿæˆå’Œæ–‡ä»¶æ“ä½œ")
    try:
        # ç”Ÿæˆé‚®ç®±
        email = executor.execute_command('data_generator', None, '', '', {
            'type': 'email'
        })
        print(f"ç”Ÿæˆé‚®ç®±: {email}")
        
        # å†™å…¥æ–‡ä»¶
        write_result = executor.execute_command('file_operation', None, '', 'test_data.txt', {
            'operation': 'write',
            'content': f"æµ‹è¯•é‚®ç®±: {email}\n"
        })
        print(f"æ–‡ä»¶å†™å…¥: {write_result}")
        
        # è¯»å–æ–‡ä»¶
        read_result = executor.execute_command('file_operation', None, '', 'test_data.txt', {
            'operation': 'read'
        })
        print(f"æ–‡ä»¶å†…å®¹: {read_result.strip()}")
        
        # åˆ é™¤æ–‡ä»¶
        delete_result = executor.execute_command('file_operation', None, '', 'test_data.txt', {
            'operation': 'delete'
        })
        print(f"æ–‡ä»¶åˆ é™¤: {delete_result}")
        
        test_results.append(('æ•°æ®ç”Ÿæˆå’Œæ–‡ä»¶æ“ä½œ', True, None))
        
    except Exception as e:
        print(f"æµ‹è¯•å¤±è´¥: {e}")
        test_results.append(('æ•°æ®ç”Ÿæˆå’Œæ–‡ä»¶æ“ä½œ', False, str(e)))
    
    # æµ‹è¯•ç”¨ä¾‹2ï¼šHTTPè¯·æ±‚
    print("\næµ‹è¯•ç”¨ä¾‹2ï¼šHTTPè¯·æ±‚")
    try:
        http_result = executor.execute_command('http_request', None, '', 'https://httpbin.org/get', {
            'method': 'GET',
            'timeout': 10
        })
        print(f"HTTPè¯·æ±‚çŠ¶æ€: {http_result['status_code']}")
        print(f"è¯·æ±‚æˆåŠŸ: {http_result['success']}")
        
        test_results.append(('HTTPè¯·æ±‚', http_result['success'], None))
        
    except Exception as e:
        print(f"HTTPè¯·æ±‚å¤±è´¥: {e}")
        test_results.append(('HTTPè¯·æ±‚', False, str(e)))
    
    # æµ‹è¯•ç”¨ä¾‹3ï¼šæ‰¹é‡æ•°æ®ç”Ÿæˆ
    print("\næµ‹è¯•ç”¨ä¾‹3ï¼šæ‰¹é‡æ•°æ®ç”Ÿæˆ")
    try:
        data_types = ['email', 'phone', 'name', 'number']
        generated_data = {}
        
        for data_type in data_types:
            step = {'type': data_type}
            if data_type == 'number':
                step.update({'min': 100, 'max': 999})
            
            result = executor.execute_command('data_generator', None, '', '', step)
            generated_data[data_type] = result
            print(f"ç”Ÿæˆ {data_type}: {result}")
        
        test_results.append(('æ‰¹é‡æ•°æ®ç”Ÿæˆ', True, None))
        
    except Exception as e:
        print(f"æ‰¹é‡æ•°æ®ç”Ÿæˆå¤±è´¥: {e}")
        test_results.append(('æ‰¹é‡æ•°æ®ç”Ÿæˆ', False, str(e)))
    
    # è¾“å‡ºæµ‹è¯•ç»“æœ
    print("\n=== æµ‹è¯•ç»“æœæ±‡æ€» ===")
    passed = 0
    failed = 0
    
    for test_name, success, error in test_results:
        status = "âœ“ é€šè¿‡" if success else "âœ— å¤±è´¥"
        print(f"{status}: {test_name}")
        if error:
            print(f"   é”™è¯¯: {error}")
        
        if success:
            passed += 1
        else:
            failed += 1
    
    print(f"\næ€»è®¡: {passed + failed} ä¸ªæµ‹è¯•ï¼Œ{passed} ä¸ªé€šè¿‡ï¼Œ{failed} ä¸ªå¤±è´¥")
    
    # ç”Ÿæˆç›‘æ§æŠ¥å‘Š
    print("\n=== æ€§èƒ½ç›‘æ§æŠ¥å‘Š ===")
    report = command_monitor.generate_report()
    plugin_commands = ['http_request', 'data_generator', 'file_operation']
    
    for cmd in plugin_commands:
        if cmd in report:
            metrics = report[cmd]
            print(f"{cmd}:")
            print(f"  æ‰§è¡Œæ¬¡æ•°: {metrics.get('execution_count', 0)}")
            print(f"  å¹³å‡æ—¶é—´: {metrics.get('avg_execution_time', 0):.3f}s")
            print(f"  æˆåŠŸç‡: {metrics.get('success_rate', 0):.1%}")
    
    return passed == len(test_results)

def main():
    """ä¸»å‡½æ•°"""
    print("æ’ä»¶é›†æˆæµ‹è¯•")
    print("=" * 50)
    
    try:
        # è®¾ç½®ç¯å¢ƒ
        setup_plugins()
        
        # è¿è¡Œæµ‹è¯•
        success = run_plugin_test_suite()
        
        if success:
            print("\nğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼")
            return 0
        else:
            print("\nâŒ éƒ¨åˆ†æµ‹è¯•å¤±è´¥")
            return 1
            
    except Exception as e:
        print(f"\nğŸ’¥ æµ‹è¯•æ‰§è¡Œå‡ºé”™: {e}")
        import traceback
        traceback.print_exc()
        return 1

if __name__ == '__main__':
    exit_code = main()
    sys.exit(exit_code)
```

## ç¬¬ä¸ƒæ­¥ï¼šä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·ç®¡ç†æ’ä»¶

### 7.1 åŸºæœ¬å‘½ä»¤

```bash
# åˆ—å‡ºæ‰€æœ‰å¯ç”¨å‘½ä»¤ï¼ˆåŒ…æ‹¬æ’ä»¶å‘½ä»¤ï¼‰
python -m src.automation.commands.command_cli list

# æŸ¥çœ‹ç‰¹å®šæ’ä»¶å‘½ä»¤çš„ä¿¡æ¯
python -m src.automation.commands.command_cli info http_request
python -m src.automation.commands.command_cli info data_generator

# å¯ç”¨/ç¦ç”¨æ’ä»¶å‘½ä»¤
python -m src.automation.commands.command_cli enable http_request
python -m src.automation.commands.command_cli disable file_operation
```

### 7.2 é…ç½®ç®¡ç†

```bash
# æŸ¥çœ‹æ’ä»¶å‘½ä»¤é…ç½®
python -m src.automation.commands.command_cli config show http_request

# è®¾ç½®æ’ä»¶å‘½ä»¤é…ç½®
python -m src.automation.commands.command_cli config set http_request timeout 60
python -m src.automation.commands.command_cli config set data_generator enabled true

# å¯¼å‡ºé…ç½®
python -m src.automation.commands.command_cli config export plugin_config.json

# å¯¼å…¥é…ç½®
python -m src.automation.commands.command_cli config import plugin_config.json
```

### 7.3 ç›‘æ§ç®¡ç†

```bash
# ç”Ÿæˆç›‘æ§æŠ¥å‘Š
python -m src.automation.commands.command_cli monitor report

# æŸ¥çœ‹ç‰¹å®šå‘½ä»¤çš„ç›‘æ§æŒ‡æ ‡
python -m src.automation.commands.command_cli monitor metrics http_request

# é‡ç½®ç›‘æ§æ•°æ®
python -m src.automation.commands.command_cli monitor reset

# å¯ç”¨/ç¦ç”¨ç›‘æ§
python -m src.automation.commands.command_cli monitor enable
python -m src.automation.commands.command_cli monitor disable
```

### 7.4 æ’ä»¶ç®¡ç†

```bash
# åˆ—å‡ºå·²åŠ è½½çš„æ’ä»¶
python -m src.automation.commands.command_cli plugin list

# åŠ è½½æ’ä»¶
python -m src.automation.commands.command_cli plugin load plugins/my_custom_plugin.py

# å¸è½½æ’ä»¶
python -m src.automation.commands.command_cli plugin unload MyCustomPlugin

# å¯ç”¨/ç¦ç”¨æ’ä»¶
python -m src.automation.commands.command_cli plugin enable MyCustomPlugin
python -m src.automation.commands.command_cli plugin disable MyCustomPlugin
```

## å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### Q1: æ’ä»¶åŠ è½½å¤±è´¥

**é—®é¢˜**ï¼šæ’ä»¶æ–‡ä»¶å­˜åœ¨ä½†åŠ è½½å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥æ’ä»¶æ–‡ä»¶è¯­æ³•æ˜¯å¦æ­£ç¡®
2. ç¡®ä¿ `PLUGIN_INFO` å­—å…¸æ ¼å¼æ­£ç¡®
3. éªŒè¯æ‰€æœ‰å¿…éœ€çš„å‡½æ•°æ˜¯å¦å·²å®ç°
4. æŸ¥çœ‹é”™è¯¯æ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯

```python
# è°ƒè¯•æ’ä»¶åŠ è½½
import logging
logging.basicConfig(level=logging.DEBUG)

plugin_manager = PluginManager()
success = plugin_manager.load_plugin('plugins/my_plugin.py')
if not success:
    print("æ£€æŸ¥æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯")
```

### Q2: æ’ä»¶å‘½ä»¤æœªæ³¨å†Œ

**é—®é¢˜**ï¼šæ’ä»¶åŠ è½½æˆåŠŸä½†å‘½ä»¤æ— æ³•ä½¿ç”¨

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç¡®ä¿ä½¿ç”¨äº†æ­£ç¡®çš„è£…é¥°å™¨ï¼š`@CommandRegistry.register('command_name')`
2. æ£€æŸ¥å‘½ä»¤åç§°æ˜¯å¦ä¸ `PLUGIN_INFO['commands']` ä¸­çš„ä¸€è‡´
3. è°ƒç”¨ `CommandRegistry.auto_discover_commands()` é‡æ–°å‘ç°å‘½ä»¤

```python
# æ£€æŸ¥å‘½ä»¤æ³¨å†ŒçŠ¶æ€
from src.automation.commands.base_command import CommandRegistry

commands = CommandRegistry.list_commands()
print(f"å·²æ³¨å†Œçš„å‘½ä»¤: {list(commands.keys())}")

# æ£€æŸ¥ç‰¹å®šå‘½ä»¤
command = CommandRegistry.get_command('my_command')
if command:
    print(f"å‘½ä»¤å·²æ³¨å†Œ: {command.__class__.__name__}")
else:
    print("å‘½ä»¤æœªæ³¨å†Œ")
```

### Q3: æ’ä»¶é…ç½®ä¸ç”Ÿæ•ˆ

**é—®é¢˜**ï¼šè®¾ç½®äº†æ’ä»¶é…ç½®ä½†ä¸ç”Ÿæ•ˆ

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç¡®ä¿è°ƒç”¨äº† `command_config_manager.save_config()`
2. æ£€æŸ¥é…ç½®é”®åæ˜¯å¦æ­£ç¡®
3. éªŒè¯æ’ä»¶æ˜¯å¦æ­£ç¡®è¯»å–é…ç½®

```python
# æ£€æŸ¥é…ç½®çŠ¶æ€
from src.automation.commands.command_config import command_config_manager

config = command_config_manager.get_command_config('my_command')
print(f"å½“å‰é…ç½®: {config}")

# å¼ºåˆ¶ä¿å­˜é…ç½®
command_config_manager.save_config()
print("é…ç½®å·²ä¿å­˜")
```

### Q4: æ’ä»¶æ€§èƒ½é—®é¢˜

**é—®é¢˜**ï¼šæ’ä»¶å‘½ä»¤æ‰§è¡Œç¼“æ…¢

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. å¯ç”¨ç›‘æ§æŸ¥çœ‹æ€§èƒ½æŒ‡æ ‡
2. ä¼˜åŒ–æ’ä»¶ä»£ç é€»è¾‘
3. è®¾ç½®åˆé€‚çš„è¶…æ—¶æ—¶é—´
4. ä½¿ç”¨å¼‚æ­¥æ‰§è¡Œï¼ˆå¦‚æœæ”¯æŒï¼‰

```python
# å¯ç”¨æ€§èƒ½ç›‘æ§
from src.automation.commands.command_monitor import command_monitor

command_monitor.enable()
command_monitor.set_threshold('my_command', 'execution_time', 5.0)

# æŸ¥çœ‹æ€§èƒ½æŠ¥å‘Š
report = command_monitor.generate_report()
if 'my_command' in report:
    metrics = report['my_command']
    print(f"å¹³å‡æ‰§è¡Œæ—¶é—´: {metrics.get('avg_execution_time', 0):.2f}s")
```

## æ€»ç»“

é€šè¿‡æœ¬æ•™ç¨‹ï¼Œæ‚¨å·²ç»å­¦ä¼šäº†ï¼š

1. **ä½¿ç”¨ç°æœ‰æ’ä»¶**ï¼šå‘ç°ã€åŠ è½½å’Œä½¿ç”¨æ’ä»¶
2. **åˆ›å»ºè‡ªå®šä¹‰æ’ä»¶**ï¼šç¼–å†™æ’ä»¶ä»£ç å’Œæµ‹è¯•
3. **é…ç½®ç®¡ç†**ï¼šè®¾ç½®å’Œç®¡ç†æ’ä»¶é…ç½®
4. **æ€§èƒ½ç›‘æ§**ï¼šç›‘æ§æ’ä»¶æ€§èƒ½å’Œè®¾ç½®å‘Šè­¦
5. **é›†æˆæµ‹è¯•**ï¼šåœ¨æµ‹è¯•ç”¨ä¾‹ä¸­ä½¿ç”¨æ’ä»¶
6. **å‘½ä»¤è¡Œç®¡ç†**ï¼šä½¿ç”¨CLIå·¥å…·ç®¡ç†æ’ä»¶
7. **æ•…éšœæ’é™¤**ï¼šè§£å†³å¸¸è§é—®é¢˜

æ’ä»¶ç³»ç»Ÿä¸ºè‡ªåŠ¨åŒ–æ¡†æ¶æä¾›äº†å¼ºå¤§çš„æ‰©å±•èƒ½åŠ›ï¼Œè®©æ‚¨å¯ä»¥æ ¹æ®å…·ä½“éœ€æ±‚æ·»åŠ è‡ªå®šä¹‰åŠŸèƒ½ï¼Œæé«˜æµ‹è¯•æ•ˆç‡å’Œè¦†ç›–èŒƒå›´ã€‚

### ä¸‹ä¸€æ­¥

- æ¢ç´¢æ›´å¤šæ’ä»¶å¼€å‘æ¨¡å¼
- åˆ›å»ºæ’ä»¶åº“å’Œåˆ†äº«æœºåˆ¶
- é›†æˆç¬¬ä¸‰æ–¹æœåŠ¡å’ŒAPI
- å¼€å‘ä¸“ä¸šé¢†åŸŸçš„æ’ä»¶ï¼ˆå¦‚æ•°æ®åº“æ“ä½œã€æ¶ˆæ¯é˜Ÿåˆ—ç­‰ï¼‰

ç¥æ‚¨ä½¿ç”¨æ„‰å¿«ï¼